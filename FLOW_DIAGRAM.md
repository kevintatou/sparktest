# TestRun CRD Flow Diagram

## Complete End-to-End Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          User Actions                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Option 1: API/GUI (Traditional)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚  â”‚ POST /runs   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                                    â”‚
â”‚                                   â–¼                                    â”‚
â”‚  Option 2: CRD (Kubernetes)      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  SparkTest Backend â”‚               â”‚
â”‚  â”‚kubectl apply â”‚ â”€â”€â”             â”‚  (Rust/Axum)       â”‚               â”‚
â”‚  â”‚testrun.yaml  â”‚   â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                      â”‚                          â”‚
â”‚                     â”‚                      â”‚ Creates                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                      â”‚
                      â”‚                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kubernetes         â”‚              â”‚ Postgres DB  â”‚
â”‚                     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                     â–²
â”‚  â”‚  TestRun    â”‚â—„â”€â”€â”€â”˜                     â”‚
â”‚  â”‚  CRD        â”‚                          â”‚
â”‚  â”‚  Resource   â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚ watched by                      â”‚
â”‚         â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚   Controller     â”‚                     â”‚
â”‚  â”‚   (Rust/kube-rs) â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â”‚                                 â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚  POSTs run with origin=crd
â”‚         â”‚
â”‚         â”œâ”€â”€â”€â–º Fetches test definition
â”‚         â”‚
â”‚         â–¼
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Kubernetes  â”‚
â”‚  â”‚  Job         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚
â”‚         â”‚ Runs
â”‚         â–¼
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  Pod         â”‚
â”‚  â”‚  (test exe)  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚
â”‚         â”‚ Updates status
â”‚         â–¼
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚  TestRun     â”‚
â”‚  â”‚  .status     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚
                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚  Frontend (Next.js/React)                            â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Runs List                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ âœ“ Test Run ABC123                   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚   [completed]                        â”‚    â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚    â”‚
â”‚  â”‚  â”‚ âŸ³ TestRun: k6-smoke-001 [CRD]      â”‚    â”‚    â”‚
â”‚  â”‚  â”‚   [running]                         â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Run Details (CRD runs)                      â”‚    â”‚
â”‚  â”‚                                              â”‚    â”‚
â”‚  â”‚  Source: Started from TestRun CRD           â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚ Namespace: sparktest [ğŸ“‹]         â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ TestRun Name: k6-smoke-001 [ğŸ“‹]   â”‚     â”‚    â”‚
â”‚  â”‚  â”‚                                    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ kubectl Commands:                  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ $ kubectl get testrun ... [ğŸ“‹]    â”‚     â”‚    â”‚
â”‚  â”‚  â”‚ $ kubectl describe testrun ... [ğŸ“‹]â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

### 1. CRD Creation

```yaml
apiVersion: sparktest.dev/v1alpha1
kind: TestRun
metadata:
  name: k6-smoke-001
  namespace: sparktest
spec:
  definitionId: b7e6c1e2-1a2b-4c3d-8e9f-100000000006
  env:
    TARGET_URL: https://api.example.com
  timeoutSeconds: 900
```

### 2. Controller Reconciliation

```rust
// Watch for TestRun resources
Controller::new(testruns, Config::default())
  .run(reconcile, error_policy, context)

// On create:
// 1. Fetch definition from backend
// 2. Build Job with env vars
// 3. Create Job in Kubernetes
// 4. POST to backend with origin=crd
// 5. Update TestRun status
```

### 3. Backend Storage

```sql
INSERT INTO test_runs (
  id, name, image, command, status,
  origin,           -- 'crd'
  k8s_ref_namespace,  -- 'sparktest'
  k8s_ref_name        -- 'k6-smoke-001'
) VALUES (...)
```

### 4. API Response

```json
{
  "id": "...",
  "name": "TestRun: k6-smoke-001",
  "status": "running",
  "origin": "crd",
  "k8sRef": {
    "namespace": "sparktest",
    "name": "k6-smoke-001"
  }
}
```

### 5. Frontend Rendering

```tsx
// In RunsList
{
  run.origin === "crd" && <span className="...">CRD</span>
}

// In RunDetails
;<CrdSourceDetails run={run} />
```

## Status Updates

```
TestRun Status       Job Status          Backend Status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Pending       â”€â”€â”
                â”‚â”€â”€â–º Job Created  â”€â”€â”
Running       â—„â”€â”˜                   â”‚â”€â”€â–º running
                                    â”‚
Succeeded     â—„â”€â”€â”€â”€ Job Succeeded â”€â”€â”˜â”€â”€â–º completed
Failed        â—„â”€â”€â”€â”€ Job Failed    â”€â”€â”€â”€â–º failed
TimedOut      â—„â”€â”€â”€â”€ Deadline Hit  â”€â”€â”€â”€â–º failed
```

## Component Architecture

```
sparktest/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ core/              # Models (RunOrigin, K8sRef)
â”‚   â”œâ”€â”€ api/               # REST handlers
â”‚   â”œâ”€â”€ controller/        # CRD controller
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ crd.rs     # TestRun CRD definition
â”‚   â”‚   â”‚   â”œâ”€â”€ reconciler.rs  # Reconciliation logic
â”‚   â”‚   â”‚   â””â”€â”€ lib.rs     # Controller runner
â”‚   â”‚   â””â”€â”€ Cargo.toml
â”‚   â””â”€â”€ migrations/        # SQL migrations
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ crd/
â”‚   â”‚   â””â”€â”€ testrun.yaml   # CRD manifest
â”‚   â”œâ”€â”€ examples/
â”‚   â”‚   â””â”€â”€ testrun-example.yaml
â”‚   â””â”€â”€ CRD_README.md      # Documentation
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ core/
â”‚       â””â”€â”€ src/
â”‚           â””â”€â”€ types.ts   # Run interface
â””â”€â”€ apps/
    â””â”€â”€ oss/
        â””â”€â”€ components/
            â”œâ”€â”€ test-runs-list.tsx  # CRD badge
            â””â”€â”€ RunDetails/
                â””â”€â”€ CrdSourceDetails.tsx  # Source info
```

## Test Coverage

```
Backend (Rust)          Frontend (TypeScript)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… 7 API tests          â¸ï¸ UI tests (deferred)
âœ… 5 Controller tests   â¸ï¸ Integration tests
âœ… 6 Core tests
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… 18 total passing
```

## Key Features

1. **Dual Entry Points**
   - API/GUI (primary, existing)
   - CRD (optional, new)

2. **Unified Storage**
   - Same `test_runs` table
   - `origin` field distinguishes source
   - `k8sRef` links to CRD resource

3. **Status Sync**
   - Controller watches Job
   - Updates TestRun.status
   - Backend reflects current state

4. **UI Integration**
   - CRD badge for identification
   - Source details with kubectl commands
   - Same UI for all runs

5. **Clean Separation**
   - CRD logic isolated in controller
   - Backend remains API-focused
   - Frontend agnostic to source
