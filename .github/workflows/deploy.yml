name: Deploy SparkTest MVP to Droplet

on:
  release:
    types: [published]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          echo "ðŸ“ Deploying SparkTest MVP from release: ${{ github.event.release.tag_name || 'manual-deploy' }}"
          
          if [ -z "$DEPLOY_HOST" ] || [ -z "$DEPLOY_USER" ] || [ -z "$DEPLOY_KEY" ]; then
            echo "âš ï¸  Deployment secrets not configured. Skipping remote deployment."
            echo "To enable deployment, configure DEPLOY_HOST, DEPLOY_USER, and DEPLOY_KEY secrets."
            exit 0
          fi

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key "$DEPLOY_USER@$DEPLOY_HOST" << 'ENDSSH'
            set -e
            cd ~/sparktest || exit 1
            
            echo "ðŸ”„ Pulling latest code..."
            git pull origin main
            
            echo "ðŸ§¹ Cleaning up existing deployment..."
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            docker image prune -f || true
            
            echo "ðŸ“¦ Building and deploying SparkTest MVP..."
            docker compose -f docker-compose.prod.yml up --build -d
            
            echo "â³ Waiting for services to be healthy..."
            sleep 45
            
            echo "ðŸ“‹ Service status:"
            docker compose -f docker-compose.prod.yml ps
            
            echo "âœ… SparkTest MVP deployed successfully!"
          ENDSSH

          # Cleanup
          rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        if: always()
        run: |
          echo "ðŸŽ‰ SparkTest MVP deployment workflow completed!"
          echo ""
          echo "ðŸ“Š Deployment status: ${{ job.status }}"
          echo "ðŸ·ï¸  Release version: ${{ github.event.release.tag_name || 'manual-deploy' }}"
